<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Ready-Set-Go Task</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    .circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 100px auto;
    }
    .ready { background-color: red; }
    .set { background-color: orange; }
    .go { background-color: green; }
  </style>
</head>
<body></body>

<script>
  const num_trials = 900;
  const feedbackTrialsCount = 900;
  const jsPsych = initJsPsych();
  const timeline = [];

  // Subject ID input
  timeline.push({
    type: jsPsychSurveyText,
    questions: [{ prompt: "Please enter your subject ID or name:", name: "subject_id" }],
    button_label: "Start",
    on_finish: function(data) {
      jsPsych.data.addProperties({ subject_ID: data.response.Q0 });
    }
  });

  // Instructions
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <p>Ready-Set-Go Task:</p>
      <ul style="text-align:left; max-width:600px; margin:auto;">
        <li>First, a <strong>red circle ("Ready")</strong> appears</li>
        <li>Then, an <strong>orange circle ("Set")</strong> appears after a delay</li>
        <li>You must <strong>press SPACE</strong> after an equal delay</li>
        <li>Then, a <strong>green circle ("Go")</strong> appears</li>
        <li>You'll get feedback for the first 5 trials.</li>
      </ul>
      <p>Press any key to begin.</p>
    `,
  });

  function make_ready_set_go_trial(interval_ms, trialIndex) {
    const setDuration = 500;

    const trialTimeline = [
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div class="circle ready"></div>',
        choices: "NO_KEYS",
        trial_duration: 500,
        data: { phase: "ready" },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        choices: "NO_KEYS",
        trial_duration: interval_ms,
        data: { phase: "isi" },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div class="circle set"></div>',
        choices: "NO_KEYS",
        trial_duration: setDuration,
        data: { phase: "set", set_duration: setDuration },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        choices: [' '],
        data: { phase: "go", target_interval: interval_ms },
        on_finish: function(data) {
          data.reproduced_interval = data.rt;
          data.reproduction_error = data.rt - data.target_interval;
        },
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div class="circle go"></div>',
        choices: "NO_KEYS",
        trial_duration: 500,
        data: { phase: "feedback_circle" },
      }
    ];

    if (trialIndex < feedbackTrialsCount) {
      trialTimeline.push(
        { 
  type: jsPsychHtmlKeyboardResponse,
  stimulus: function() {
    const lastGo = jsPsych.data.get().filter({ phase: 'go' }).last(1).values()[0];
    const target = lastGo.target_interval;
    const reproduced = lastGo.reproduced_interval;
    const error = lastGo.reproduction_error;
    const current = jsPsych.data.get().filter({ phase: "go" }).count() + 1;
    // Clamp error to range [-500, +500] for display
    const clampedError = Math.max(-500, Math.min(500, error));
    const percent = (clampedError + 500) / 1000 * 100;

    return `
      <div style="text-align:center;">
        
        <p style="font-size: 16px; text-align: center;">Trial ${current} of ${num_trials}</p>
        <p><strong>Error:</strong> ${error > 0 ? '+' : ''}${Math.round(error)} ms</p>

        <div style="position: relative; width: 80%; height: 40px; margin: 40px auto;">
          <div style="height: 8px; background: linear-gradient(to right, #3498db, #ccc, #e74c3c); border-radius: 4px;"></div>
          <div style="position: absolute; left: ${percent}%; top: -6px; transform: translateX(-50%);">
            <div style="width: 14px; height: 14px; background: black; border-radius: 50%; border: 2px solid white;"></div>
          </div>
          <div style="position: absolute; left: 0%; top: 20px; font-size: 12px;">â€“500 ms</div>
          <div style="position: absolute; left: 50%; top: 20px; font-size: 12px; transform: translateX(-50%);">0</div>
          <div style="position: absolute; right: 0%; top: 20px; font-size: 12px;">+500 ms</div>
        </div>

        <p>Press any key to continue.</p>
      </div>
    `;
  },
  data: { phase: "feedback_text" },
          choices:"NO_KEYS",
          trial_duration: 500,
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '<p style="font-size: 48px;">+</p>',
          choices: "NO_KEYS",
          trial_duration: 1000,
          data: { phase: "iti" },
        }
      );
    } else {
      trialTimeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          const current = jsPsych.data.get().filter({ phase: "go" }).count() + 1;
          return `<p style="font-size: 48px;">+</p>
                  <p style="font-size: 16px; text-align: center;">Trial ${current} of ${num_trials}</p>`;
        },
        choices: "NO_KEYS",
        trial_duration: 1000,
        data: { phase: "iti" },
      });
    }

    return trialTimeline;
  }

  // Define trial structure
  const trials_per_block = Math.floor(num_trials / 3);
  const blocks = [
    // { lower: 494, upper: 847 },
    { lower: 671, upper: 1023 },
    { lower: 671, upper: 1023 },
    { lower: 671, upper: 1023 },

    // { lower: 847, upper: 1200 }
  ];
  const randomizedBlocks = jsPsych.randomization.shuffle(blocks);
  let trialIndex = 0;

  randomizedBlocks.forEach((block, blockIndex) => {
    if (blockIndex > 0) {
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p><strong>Block change. Press any key to continue.</strong></p>`,
        choices: "ALL_KEYS",
        data: { phase: "block_transition" }
      });
    }

    const n = 7;
    const intervals = Array.from({ length: n }, (_, i) =>
      Math.round((block.lower + (i * (block.upper - block.lower)) / (n - 1)) / 10) * 10
    );

    for (let i = 0; i < trials_per_block; i++) {
      const interval = jsPsych.randomization.sampleWithReplacement(intervals, 1)[0];
      timeline.push(...make_ready_set_go_trial(interval, trialIndex));
      trialIndex++;
    }
  });

  // Final feedback
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="text-align:center;">
        <h2>End of Task</h2>
        <p>Press any key to download your data.</p>
      </div>
    `,
    choices: "ALL_KEYS"
  });

  // Download CSV
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p>Click below to download your data as a CSV file.</p>',
    choices: ['Download CSV'],
    on_finish: function() {
      const csv = jsPsych.data.get().csv();
      const now = new Date();
      const filename = `readysetgo_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${Math.floor(Math.random()*1e6).toString().padStart(6,'0')}.csv`;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
  });

  jsPsych.run(timeline);

  // ===== Add Stop & Save Button =====
  window.onload = () => {
  const stopButton = document.createElement('button');
  stopButton.innerHTML = 'ðŸ›‘ Stop and Save';
  stopButton.style.position = 'fixed';
  stopButton.style.bottom = '20px';
  stopButton.style.right = '20px';
  stopButton.style.padding = '10px 16px';
  stopButton.style.fontSize = '16px';
  stopButton.style.backgroundColor = '#d9534f';
  stopButton.style.color = 'white';
  stopButton.style.border = 'none';
  stopButton.style.borderRadius = '5px';
  stopButton.style.zIndex = '1000';
  stopButton.style.cursor = 'pointer';

  stopButton.addEventListener('click', () => {
    if (confirm("Stop the experiment and download the data collected so far?")) {
      const csv = jsPsych.data.get().csv();
      const now = new Date();
      const filename = `readysetgo_partial_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${Math.floor(Math.random()*1e6).toString().padStart(6,'0')}.csv`;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      jsPsych.endExperiment("Experiment stopped early.");
    }
  });

  document.body.appendChild(stopButton);
};

  stopButton.addEventListener('click', () => {
    if (confirm("Stop the experiment and download the data collected so far?")) {
      const csv = jsPsych.data.get().csv();
      const now = new Date();
      const filename = `readysetgo_partial_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${Math.floor(Math.random()*1e6).toString().padStart(6,'0')}.csv`;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      jsPsych.endExperiment("Experiment stopped early.");
    }
  });
</script>
</html>
